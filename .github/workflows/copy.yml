# This is a basic workflow to help you get started with Actions

name: Copy Secrets

# Controls when the workflow will run
on:
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'
      - run: npm install libsodium
      - uses: actions/github-script@v7
        env:
          ghToken: ${{ secrets.GITHUB_TOKEN }}
          envName: "dev"
          repoId: ${{ github.repository_id }}
          secret1: ${{ secrets.DEV_SECRET_1 }}
        with:
          script: |
            const { Octokit } = require("@octokit/core");
            const octokit = new Octokit({
              auth: `{process.env.ghToken}`
            })
            const publicKeyResponse = await octokit.request('GET /repositories/{repository_id}/environments/{environment_name}/secrets/public-key', {
              repository_id: process.env.repoId,
              environment_name: process.env.envName,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            })
            console.log("Got env public key")
            const publicKey = publicKeyResponse.data.key;
            const publicKeyId = publicKeyResponse.data.key_id;
            const sodium = require('libsodium-wrappers');
            await sodium.ready;
            
            // Convert the secret and key to a Uint8Array.
            let binkey = sodium.from_base64(publicKey, sodium.base64_variants.ORIGINAL)
            let binsec = sodium.from_string(process.env.secret1)
          
            // Encrypt the secret using libsodium
            let encBytes = sodium.crypto_box_seal(binsec, binkey)
          
            // Convert the encrypted Uint8Array to Base64
            let output = sodium.to_base64(encBytes, sodium.base64_variants.ORIGINAL)
          
            console.log(`encrypted with env ${process.env.envName} public key - and about to PUT a secret in it`)

            await octokit.request('PUT /repositories/{repository_id}/environments/{environment_name}/secrets/{secret_name}', {
              repository_id: process.env.repoId,
              environment_name: process.env.envName,
              secret_name: 'DEV_SECRET_1',
              encrypted_value: output,
              key_id: publicKeyId,
              headers: {
                'X-GitHub-Api-Version': '2022-11-28'
              }
            })
            console.log("done")
            
          


